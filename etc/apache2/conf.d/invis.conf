# Apache Grundkonfiguration fuer invis-Server
# Konfiguration reagiert auf unterschiedliche Apache-Setups

# Globaler DirectoryIndex
DirectoryIndex index.php login.pl index.pl index.html

<IfModule worker.c>
    <IfModule mod_fcgid.c>
	FcgidMaxRequestLen 10485760
	<FilesMatch "\.php$">
	    AddHandler fcgid-script .php
	    FCGIWrapper /usr/bin/php-cgi .php
	    Options +ExecCGI
	</FilesMatch>

# Anpassungen an Zarafa Webaccess und Webapp
#	<Directory /usr/share/zarafa-webaccess>
#	    AllowOverride None
#	</Directory>
#	<Directory /usr/share/zarafa-webapp>
#	    AllowOverride None
#	</Directory>
    </IfModule>
</IfModule>

<IfDefine FCGID>
    AddHandler fcgid-script .pl
</IfDefine>
<IfDefine !FCGID>
    AddHandler cgi-script .pl
</IfDefine>

<IfModule mod_php5.c>
    php_admin_flag magic_quotes_gpc off
    php_admin_flag allow_url_include off
    php_admin_flag allow_url_fopen off
    php_admin_flag zend.ze1_compatibility_mode off
    php_admin_flag safe_mode Off
    # customize suhosin
    php_admin_value suhosin.post.max_array_index_length 256
    php_admin_value suhosin.post.max_totalname_length 8192
    php_admin_value suhosin.post.max_vars 2048
    php_admin_value suhosin.request.max_array_index_length 256
    php_admin_value suhosin.request.max_totalname_length 8192
    php_admin_value suhosin.request.max_vars 2048
</IfModule>

# HTTP-Proxy fuer lokale Zugriffe auf abweichenden Ports
<IfModule mod_proxy.c>
    ProxyHTMLEnable On
    ProxyRequests Off
# PROXY FOR SHELL-IN-A-BOX
    <Location /shell>
	RequestHeader unset Accept-Encoding
	ProxyPass http://127.0.0.1:4200
	ProxyPassReverse http://127.0.0.1:4200
    </Location>
# NTOP
# Auch bei NTOP funktioniert der Zugriff via Reverse Proxy nicht.
#    <Location /ntop>
#	ProxyPass http://127.0.0.1:3000
#	ProxyPassReverse http://127.0.0.1:3000
#    </Location>
</IfModule>

# Passwortschutz fuer das DocumentRoot Verzeichnis
# des Webservers ermoeglichen
<Directory "/srv/www/htdocs">
    # Zugriff auf Dateien, die mit .ht beginnen
    <Files ~ "^\.ht">
	require host localhost
    </Files>
    AllowOverride AuthConfig Limit
    AcceptPathInfo On
</Directory>

# Der Angabe des Hostnamens aus der URL des Clients vertrauen
UseCanonicalName Off

#Aliasnamen für Elemente ausserhalb des Portalverzeichnisses

Alias /cornaz /srv/www/htdocs/cornaz
Alias /handbuch /usr/share/doc/manual/opensuse-startup_de/
Alias /phpldapadmin /srv/www/htdocs/phpldapadmin
Alias /phpMyAdmin /srv/www/htdocs/phpMyAdmin
Alias /phpPgAdmin /srv/www/htdocs/phpPgAdmin
Alias /dokuwiki /srv/www/htdocs/dokuwiki
Alias /vbphp /srv/www/htdocs/phpvirtualbox

# SSI Handler / ServerSideIncludes erlauben
<Directory /srv/www/htdocs>
    AddType text/html .shtml
    AddHandler server-parsed shtml
    Options +Includes
</Directory>

# ownCloud Version: 8.1.9
<Directory /srv/www/htdocs/owncloud>
    AllowOverride FileInfo Options Indexes AuthConfig
    Options +SymLinksIfOwnerMatch
</Directory>

# Test für LX-Office
#EnableSendfile Off
AddDefaultCharset utf-8

# Use the IfDefine Tag if you want the Kimai configuration 
# switchable
<IfDefine KIMAI>
    # Alias definieren
    Alias /kimai /srv/www/htdocs/kimai

    <Directory /srv/www/htdocs/kimai/temporary/>
        <IfVersion >= 2.4>
            Require all denied
        </IfVersion>
        <IfVersion < 2.4>
            Order allow,deny
            Deny from all
        </IfVersion>
    </Directory>
    <Directory /srv/www/htdocs/kimai/includes/>
        <IfVersion >= 2.4>
            Require all denied
        </IfVersion>
        <IfVersion < 2.4>
            Order allow,deny
            Deny from all
        </IfVersion>
    </Directory>
    <Directory /srv/www/htdocs/kimai/libraries/tecnickcom/tcpdf/tools/>
        <IfVersion >= 2.4>
            Require all denied
        </IfVersion>
        <IfVersion < 2.4>
            Order allow,deny
            Deny from all
        </IfVersion>
    </Directory>
</IfDefine>

<IfDefine TINE20>
    ### Suggested Alias-based tine20-configuration
    ### Have a look to the documentation in:
    ### /usr/share/doc/packages/tine20/README.DISTRIBUTION
    Alias   /tine20           "/var/lib/tine20/webroot"

    ### The rewrite-engine is needed for ActiveSync or DAV services
    <IfModule mod_rewrite.c>
	RewriteEngine on
	#RewriteBase /
	#
	### ActiveSync configuration
	#RewriteRule ^Microsoft-Server-ActiveSync /tine20/index.php?frontend=activesync [E=REMOTE_USER:%{HTTP:Authorization},L,QSA]
	#
	### OpenID
	#RewriteRule ^users/(.*)   /tine20/index.php?frontend=openid&username= [L,QSA]
	#
	### WebDAV / CalDAV / CardDAV configuration
	RewriteCond %{REQUEST_METHOD} !^(GET|POST)$
	RewriteRule ^$            /tine20/index.php?frontend=webdav [E=REMOTE_USER:%{HTTP:Authorization},L,QSA]
	RewriteRule ^addressbooks /tine20/index.php?frontend=webdav [E=REMOTE_USER:%{HTTP:Authorization},L,QSA]
	RewriteRule ^calendars    /tine20/index.php?frontend=webdav [E=REMOTE_USER:%{HTTP:Authorization},L,QSA]
	RewriteRule ^principals   /tine20/index.php?frontend=webdav [E=REMOTE_USER:%{HTTP:Authorization},L,QSA]
	RewriteRule ^webdav       /tine20/index.php?frontend=webdav [E=REMOTE_USER:%{HTTP:Authorization},L,QSA]
    </IfModule>
    <Directory /var/lib/tine20>
	Require all granted
	Options +FollowSymLinks
	php_admin_value session.gc_maxlifetime 86400
	php_admin_value memory_limit 128M
	php_admin_value upload_max_filesize 20M
	php_admin_value post_max_size 20M
	php_admin_flag display_errors off
	php_admin_flag log_errors on
	php_admin_flag magic_quotes_runtime off
	php_admin_flag register_globals off
	php_admin_flag magic_quotes_gpc off
	php_admin_flag allow_url_include off
	php_admin_flag allow_url_fopen off
	php_admin_flag safe_mode Off
	php_admin_value session.save_path /var/lib/tine20/session
	php_admin_value upload_tmp_dir /var/lib/tine20/tmp
	php_admin_value open_basedir /var/lib/tine20:/usr/share/tine20:/usr/share/php5/PEAR:/usr/share/php5/Zend
	php_admin_value max_execution_time 120
	php_admin_value max_input_time 120
    </Directory>
</IfDefine>


<IfDefine SSL>
    <IfDefine !NOSSL>
	<IfModule mod_ssl.c>
	
	## Umsetzung von Perfect Forward Secrecy
	
	# Nur SSL-Protokolle ab TLS V. 1.0 aufwaerts zulassen
	SSLProtocol all -SSLv2 -SSLv3
	
	# Clients zwingen sich an die CipherSuite Vorgaben des Servers zu halten
	SSLHonorCipherOrder On
	
	# Sichere CipherSuites, die Diffie Hellman basierte Schluesselaustaus-
	# verfahren verwenden, bevorzugen. 
	# Sollte nur verwendet werden, wenn aeltere Browser zwingend auf den
	# Server zugrifen muessen.
	# SSLCipherSuite "ECDHE-ECDSA-AES128-GCM-SHA256 ECDHE-ECDSA-AES256-GCM-SHA384 ECDHE-RSA-AES128-GCM-SHA256 ECDHE-RSA-AES256-GCM-SHA384 DHE-RSA-AES128-GCM-SHA256 DHE-RSA-AES256-GCM-SHA384 ECDHE-ECDSA-AES128-SHA ECDHE-ECDSA-AES256-SHA ECDHE-ECDSA-DES-CBC3-SHA ECDHE-RSA-AES128-SHA ECDHE-RSA-AES256-SHA ECDHE-RSA-DES-CBC3-SHA DHE-RSA-AES128-SHA DHE-RSA-AES256-SHA EDH-RSA-DES-CBC3-SHA AES128-GCM-SHA256 AES256-GCM-SHA384 AES128-SHA AES256-SHA DES-CBC3-SHA"

	# Ausschlieslich sichere CipherSuites, die Diffie Hellman basierte Schluesselaustaus-
	# verfahren verwenden, verwenden.
	# diese Methode wird bevorzugt, schließt aber aeltere Browser wie z.B. IE8 aus.
	SSLCipherSuite "ECDHE-ECDSA-AES128-GCM-SHA256 ECDHE-ECDSA-AES256-GCM-SHA384 ECDHE-RSA-AES128-GCM-SHA256 ECDHE-RSA-AES256-GCM-SHA384 DHE-RSA-AES128-GCM-SHA256 DHE-RSA-AES256-GCM-SHA384 ECDHE-ECDSA-AES128-SHA ECDHE-ECDSA-AES256-SHA ECDHE-ECDSA-DES-CBC3-SHA ECDHE-RSA-AES128-SHA ECDHE-RSA-AES256-SHA ECDHE-RSA-DES-CBC3-SHA DHE-RSA-AES128-SHA DHE-RSA-AES256-SHA EDH-RSA-DES-CBC3-SHA"
	
	## Ab Apache 2.2.24 sollte folgende Zeile aktiviert werden. Wehrt "CRIME" Attacke ab
	# SSLCompression off
	
	</IfModule>
    </IfDefine>
</IfDefine>
